<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>TimeTrackingService Implementation</title>
</head>
<body>
    <h2>TimeTrackingService Implementation</h2>
    <!------------------------- Intro Text ------------------------->
    <p>
        In this section we will implement the <code>TimeTrackingService</code> and make
        sure it passes the tests.
    </p>
    <!------------------------- Main Text ------------------------->
    <p>
        We will first need to enhance our domain model to support the new value objects
        <code>TimecardSearchCriteriaVO</code> and <code>TimecardSummaryVO</code>. Note that
        <code>TimecardSearchCriteriaVO</code> is simply a data transfer object that specifies
        search parameters. There is no domain entity needed to express this concept. However
        <code>TimecardSummaryVO</code> represents a timecard entity and must be added to
        the domain model. The diagram below shows the model of this entity.
    </p>
    <p>
        {mosimage}
        <!-- img src="Images/Timecard.jpg" alt="Timecard" / -->
    </p>
    <p>
        <code>Timecard</code> has two associations with the <code>User</code> entiry:
    </p>
    <ol>
        <li>submitter: the person who has submits the timecard</li>
        <li>approver: the person who approves the timecard</li>
    </ol>
    <p>
        The arrows on the two associations indicate that both associations are navigable
        from <code>Timecard</code> to <code>Person</code>, i.e. the timecard keeps references
        to its submitter and approver. Note that two-way navigability is indicated by not
        having arrows at either end of the association. The numbers and stars at the ends
        of the associations indicate their multiplicity. The top association indicates that
        a timecard can have one submitter, but a submitter can submit many timecards (shown
        by the "*"). Similarly the bottom association indicates that a timecard can have
        zero or one approver, but an approver can approve many timecards. We allow for zero
        approvers on a timecard so that the decision to assign an approver can be delayed
        until the timecard is submitted.
    </p>
    <p>
        We have also added a method called <code>findByCriteria()</code> on the <code>Timecard</code>
        entity. <code>TimeTrackingService</code> will essentially use this method to find
        timecards. Note the underline on the <code>findByCriteria()</code> method - it represents
        a "classifier" scope in UML. If there was no underline on the method that would
        imply "instance" scope. This is an important concept in AndroMDA, so pay attention.
        <strong>A method with classifier scope is a general purpose utility method which operates
            on one or more entities. Such methods are generated in the DAO classes. A method
            with instance scope is a method on the entity itself and is generated in the Entity
            and EntityImpl classes.</strong>
    </p>
    <p>
        We are now ready to add the <code>Timecard</code> entity to the TimeTracker model
        along with the two associations to the <code>User</code> entity. Please follow one
        of the links below to edit the model with the UML tool of your choice.
    </p>
    <ul>
        <li><a href="/index.php?option=com_content&amp;task=view&amp;id=193&amp;Itemid=42"
            target="_blank">ArgoUML</a></li>
        <li><a href="/index.php?option=com_content&amp;task=view&amp;id=157&amp;Itemid=42"
            target="_blank">MagicDraw 9.x</a></li>
        <li><a href="/index.php?option=com_content&amp;task=view&amp;id=171&amp;Itemid=42"
            target="_blank">MagicDraw 15.5</a></li>
        <li><a href="/index.php?option=com_content&amp;task=view&amp;id=175&amp;Itemid=42"
            target="_blank">RSM 6</a></li>
    </ul>
    <p>
        Next add a dependency from the <code>Timecard</code> entity to the <code>TimecardSummaryVO</code>
        as shown below. As you know, this dependency tells AndroMDA to generate conversion
        methods between <code>Timecard</code> and <code>TimecardSummaryVO</code> objects.
        The conversion methods are generated in <code>TimecardDaoBase</code>. However, note
        that <code>TimecardSummaryVO</code> contains attributes fetched from another entity,
        namely <code>User</code>, so we will have to override the default conversion methods
        to fill in these additional attributes.
    </p>
    <table width="100%" border="0">
        <tbody>
            <tr>
                <!-- img src="Images/TimecardToTimecardSummaryVODependency.jpg" alt="Timecard To TimecardSummaryVO Dependency" / -->
                <td align="center" style="width: 100%">
                    {mosimage}</td>
            </tr>
        </tbody>
    </table>
    <p>
        Next add a dependency from <code>TimeTrackingService</code> to the <code>Timecard</code>
        entity as shown below. As you know, this dependency tells AndroMDA to give <code>TimeTrackingService</code>
        access to the <code>Timecard</code> entity.
    </p>
    <table width="100%" border="0">
        <tbody>
            <tr>
                <!-- img src="Images/TimeTrackingServiceToTimecardDependency.jpg" alt="TimeTrackingService To Timecard Dependency" / -->
                <td align="center" style="width: 100%">
                    {mosimage}</td>
            </tr>
        </tbody>
    </table>
    <p>
        Now let's ask AndroMDA to generate code for the <code>Timecard</code> entity:
    </p>
    <ol>
        <li>Execute the command <code>mvn install</code> in the Command Prompt. Note that the
            build will not succeed because the test will still fail, however the code generation
            part should succeed.</li>
    </ol>
    <p>
        <strong>Eclipse Users:</strong> Open the AndroMDA generated <code>.classpath</code>
        file. Note that AndroMDA does not add <code>TestNG</code> to the classpath. Add
        the following entry to this file to make sure <code>TestNG</code> is in the classpath.
        Furthermore, if you do not want AndroMDA to overwrite the modified <code>.classpath</code>
        file, simply disable its generation by commenting out the <code>andromdapp-maven-plugin</code>
        section in <code>mda\pom.xml</code> (look at the completed solution to see how this
        is done).
    </p>
    <pre>
&lt;classpathentry kind="var" path="M2_REPO/org/testng/testng/4.7/testng-4.7-jdk15.jar"/&gt;
    </pre>
    <p>
        Now let's start by implementing the <code>findByCriteria()</code> method. Add the
        bold lines shown in the listing below to your <code>TimeTrackingServiceImpl</code>
        class.
    </p>
    <pre>
// license-header java merge-point
/**
 * This is only generated once! It will never be overwritten.
 * You can (and have to!) safely modify it by hand.
 */
package org.andromda.timetracker.service;

<b>import java.util.List;</b>

<b>import org.andromda.timetracker.vo.TimecardSummaryVO;</b>

/**
 * @see org.andromda.timetracker.service.TimeTrackingService
 */
public class TimeTrackingServiceImpl
    extends org.andromda.timetracker.service.TimeTrackingServiceBase
{

    /**
     * @see org.andromda.timetracker.service.TimeTrackingService#findTimecards(...)
     */
    protected org.andromda.timetracker.vo.TimecardSummaryVO[] handleFindTimecards(
            org.andromda.timetracker.vo.TimecardSearchCriteriaVO criteria)
        throws java.lang.Exception
    {
    	<b>List timecards = getTimecardDao().findByCriteria(criteria);</b>
    	<b>getTimecardDao().toTimecardSummaryVOCollection(timecards);</b>
    	<b>return (TimecardSummaryVO[])timecards.toArray(new TimecardSummaryVO[0]);</b>
    }
}
    </pre>
    <p>
        We first make a call to the <code>findByCriteria()</code> method in <code>TimecardDao</code>.
        Remember this was a classifier scope method that we added to the <code>Timecard</code>
        entity? We will implement this method manually. <code>findByCriteria()</code> returns
        a list of matching <code>Timecard</code> entities. However, <code>handleFindTimecards()</code>
        needs to return an array of <code>TimecardSummaryVO</code> objects. So we first
        use a <code>TimecardDao</code> helper method to convert the entity list to a VO
        collection, then we convert this collection to an array and return it.
    </p>
    <p>
        Now implement the <code>handleFindByCriteria()</code> method in <code>TimecardDaoImpl.java</code>
        as shown below. We also show the imports needed for this method. Note that the code
        uses a Hibernate <em>criteria</em> query to implement the search functionality.
        However, we will not go into the details of the implementation as it is outside
        the scope of this tutorial.
    </p>
    <pre>
package org.andromda.timetracker.domain;

import org.hibernate.Criteria;
import org.hibernate.FetchMode;
import org.hibernate.criterion.Restrictions;

/**
 * @see org.andromda.timetracker.domain.Timecard
 */
public class TimecardDaoImpl
    extends org.andromda.timetracker.domain.TimecardDaoBase
{
    ...
    protected java.util.List handleFindByCriteria(
        org.andromda.timetracker.vo.TimecardSearchCriteriaVO criteria)
    {
        // Create the timecard criteria
        Criteria timecardCriteria = this.getSession()
            .createCriteria(Timecard.class)
            .setFetchMode("submitter", FetchMode.JOIN)
            .setFetchMode("approver", FetchMode.JOIN);

        // Add submitter criteria
        if (criteria.getSubmitterId() != null) {
            timecardCriteria.createCriteria("submitter")
                .add(Restrictions.idEq(criteria.getSubmitterId()));
        }

        // Add approver criteria
        if (criteria.getApproverId() != null) {
            timecardCriteria.createCriteria("approver")
                .add(Restrictions.idEq(criteria.getApproverId()));
        }

        // Add status criteria
        if (criteria.getStatus() != null) {
        	timecardCriteria.add(Restrictions.eq("status", criteria.getStatus()));
        }

        // Add startDateMin criteria
        if (criteria.getStartDateMin() != null) {
        	timecardCriteria.add(
        	    Restrictions.ge("startDate", criteria.getStartDateMin()));
        }

        // Add startDateMax criteria
        if (criteria.getStartDateMax() != null) {
        	timecardCriteria.add(
        	    Restrictions.le("startDate", criteria.getStartDateMax()));
        }

        java.util.List timecards = timecardCriteria.list();
        if (logger.isDebugEnabled()) {
            logger.debug(timecards.size() + " timecards found");
        }
        return timecards;
    }
    ...
}
    </pre>
    <p>
        Now change the default implementation of <code>toTimecardSummaryVO()</code> in <code>
            TimecardDaoImpl</code> since it is not correct. Note that this method will be
        called by <code>TimeTrackerService.findByCriteria()</code> to convert <code>Timecard</code>
        entities. Currently, <code>toTimecardSummaryVO()</code> simply calls the corresponding
        method in its parent class (<code>TimecardDaoBase</code>). If you remember, the
        default converter implementations in <code>DaoBase</code> classes are very simplistic.
        Specifically, the <code>TimecardDaoBase</code> class copies only <code>Timecard</code>
        attributes to <code>TimecardSummaryVO</code>; it does not fill in the attributes
        that come from related entities, namely <code>submitterName</code> and <code>approverName</code>.
        So modify <code>toTimecardSummaryVO()</code> in <code>TimecardDaoImpl</code> as
        shown below, filling in the remaining attributes.
    </p>
    <pre>
    public void toTimecardSummaryVO(
        org.andromda.timetracker.domain.Timecard sourceEntity,
        org.andromda.timetracker.vo.TimecardSummaryVO targetVO)
    {
        super.toTimecardSummaryVO(sourceEntity, targetVO);
        targetVO.setSubmitterName(sourceEntity.getSubmitter().getUsername());
        if (sourceEntity.getApprover() != null) {
            targetVO.setApproverName(sourceEntity.getApprover().getUsername());
        }
    }
    </pre>
    <p>
        The last thing we need to do is to create the <code>Timecard</code> table in the
        database and populate it with data. Follow the steps below to accomplish this:
    </p>
    <ol>
        <li>Run the following command in the Command Prompt, asking AndroMDA to create our database
            schema:<br />
            <code>mvn -f core/pom.xml andromdapp:schema -Dtasks=create</code><br />
            Make sure you get a <code>BUILD SUCCESSFUL</code> message</li>
        <li>Open MySQL Query Browser. Login as timetracker. You should see the <code>user</code>
            and <code>timecard</code> tables in the <code>timetracker</code> schema.</li>
        <li>Select File > New Script Tab and paste the following SQL script in the new tab.
            <pre>
insert into USERS (ID, USERNAME, FIRST_NAME, LAST_NAME)
    values (1, 'nbhatia',      'Naresh', 'Bhatia');
insert into USERS (ID, USERNAME, FIRST_NAME, LAST_NAME)
    values (2, 'lcoude',       'Louis',  'Coude');
insert into USERS (ID, USERNAME, FIRST_NAME, LAST_NAME)
    values (3, 'ecrutchfield', 'Eric',   'Crutchfield');
insert into USERS (ID, USERNAME, FIRST_NAME, LAST_NAME)
    values (4, 'cmicali',      'Chris',  'Micali');

insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 1, 'Approved',  '2006/05/15', 'Timecard 01', 1, 2);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 2, 'Approved',  '2006/05/15', 'Timecard 02', 2, 3);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 3, 'Approved',  '2006/05/15', 'Timecard 03', 3, 4);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 4, 'Approved',  '2006/05/15', 'Timecard 04', 4, 1);

insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 5, 'Rejected',  '2006/05/22', 'Timecard 05', 1, 2);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 6, 'Rejected',  '2006/05/22', 'Timecard 06', 2, 3);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 7, 'Rejected',  '2006/05/22', 'Timecard 07', 3, 4);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 8, 'Rejected',  '2006/05/22', 'Timecard 08', 4, 1);

insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values ( 9, 'Submitted', '2006/05/29', 'Timecard 09', 1, 2);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (10, 'Submitted', '2006/05/29', 'Timecard 10', 2, 3);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (11, 'Submitted', '2006/05/29', 'Timecard 11', 3, 4);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (12, 'Submitted', '2006/05/29', 'Timecard 12', 4, 1);

insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (13, 'Draft',     '2006/06/05', 'Timecard 13', null, 2);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (14, 'Draft',     '2006/06/05', 'Timecard 14', null, 3);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (15, 'Draft',     '2006/06/05', 'Timecard 15', null, 4);
insert into TIMECARD (ID, STATUS, START_DATE, COMMENTS, APPROVER_FK, SUBMITTER_FK)
    values (16, 'Draft',     '2006/06/05', 'Timecard 16', null, 1);
            </pre>
        </li>
        <li>Click the Execute button on the top right.</li>
    </ol>
    <p>
        Well, we think that <code>TimeTrackingService</code> is now completely implemented.
        Let's execute the command below to run the tests again and see what happens:
    </p>
    <pre>
C:\timetracker>mvn -f core/pom.xml test
...
...
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running Services Test
Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.272 sec

Results :
Tests run: 3, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESSFUL
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 30 seconds
[INFO] Finished at: Fri Aug 11 21:05:53 EDT 2006
[INFO] Final Memory: 6M/14M
[INFO] ------------------------------------------------------------------------
    </pre>
    <p>
        Great! All tests passed. Open <code>C:\timetracker\core\timetracker-test.log</code>
        to see the results. You should see the following output:
    </p>
    <pre>
21:05:46.850 INFO  - Initializing ServiceLocator
21:05:46.870 INFO  - Initializing UserService
21:05:51.767 INFO  - Initializing ServiceLocator
21:05:51.767 INFO  - Initializing TimeTrackingService
21:05:51.858 INFO  - testFindAllTimecards:
...
21:05:52.819 DEBUG - 16 timecards found
21:05:52.859 INFO  - Submitter     Approver      Status     Start Date
21:05:52.869 INFO  - nbhatia       cmicali       Approved   05/15/06
21:05:52.869 INFO  - nbhatia       cmicali       Rejected   05/22/06
21:05:52.869 INFO  - nbhatia       cmicali       Submitted  05/29/06
21:05:52.869 INFO  - nbhatia       null          Draft      06/05/06
21:05:52.869 INFO  - lcoude        nbhatia       Approved   05/15/06
21:05:52.869 INFO  - lcoude        nbhatia       Rejected   05/22/06
21:05:52.869 INFO  - lcoude        nbhatia       Submitted  05/29/06
21:05:52.869 INFO  - lcoude        null          Draft      06/05/06
21:05:52.869 INFO  - ecrutchfield  lcoude        Approved   05/15/06
21:05:52.869 INFO  - ecrutchfield  lcoude        Rejected   05/22/06
21:05:52.869 INFO  - ecrutchfield  lcoude        Submitted  05/29/06
21:05:52.869 INFO  - ecrutchfield  null          Draft      06/05/06
21:05:52.869 INFO  - cmicali       ecrutchfield  Approved   05/15/06
21:05:52.869 INFO  - cmicali       ecrutchfield  Rejected   05/22/06
21:05:52.869 INFO  - cmicali       ecrutchfield  Submitted  05/29/06
21:05:52.869 INFO  - cmicali       null          Draft      06/05/06
21:05:52.879 INFO  - testFindTimecardsForSubmitter:
...
21:05:52.959 DEBUG - 4 timecards found
21:05:52.959 INFO  - Submitter     Approver      Status     Start Date
21:05:52.969 INFO  - nbhatia       cmicali       Approved   05/15/06
21:05:52.969 INFO  - nbhatia       cmicali       Rejected   05/22/06
21:05:52.969 INFO  - nbhatia       cmicali       Submitted  05/29/06
21:05:52.969 INFO  - nbhatia       null          Draft      06/05/06
...
    </pre>
    <h3>What's Next?</h3>
    <p>
        Now that <code>TimeTrackingService.findByCriteria()</code> method is working, let's
        try to use it from the front-end. Click the <em>Next</em> link below to implement
        the search results panel of the search screen, which needs to call this method.
    </p>
</body>
</html>
