<project default="jar:install"
         xmlns:j="jelly:core"
         xmlns:maven="jelly:maven"
  		 xmlns:ant="jelly:ant">
  		 
  	<j:set var="parser.src.dir" value="${maven.src.dir}/parser"/>
  	<j:set var="parser.src.generated.dir" value="${maven.build.src}/java"/>
  	<j:set var="parser.grammer.file" value="ocl.grammar"/>

    <preGoal name="java:jar-resources">
        <ant:filter token="pom.currentVersion" value="${pom.currentVersion}" />
        <ant:filter filtersfile="${maven.src.dir}/META-INF/andromda-version.properties" />

        <ant:tstamp>
			<ant:format property="build.timestamp" pattern="yyyy-MM-dd HH:mm:ss" locale="en"/>
        </ant:tstamp>
        <ant:filter token="build.date" value="${build.timestamp}" />
        <ant:filter token="build.system" value="${os.name}-${os.version}" />
        <ant:filter token="build.jdk" value="${java.vm.vendor}-${java.vm.version}" />
        <ant:filter token="build.builder" value="${user.name}" />
        <ant:filter filtersfile="${maven.src.dir}/META-INF/andromda-build.properties" />
    </preGoal>
  		 
    <preGoal name="java:compile" > 
  		<attainGoal name="build-parser"/>
  		<!-- add the path of the generated source to the
  		     maven compile path -->
	 	<ant:path
	       	id="parser.gen.src"
	       	location="${parser.src.generated.dir}"/>
		<maven:addPath
	       	id="maven.compile.src.set"
	       	refid="parser.gen.src"/>
	    <ant:property name="path" refid="maven.dependency.classpath"/>
    </preGoal>

    <!-- ===================================================================
         Checks if the parser generated code needs to be generated/re-generated
         =================================================================== -->
  	<goal name="check-parser-required">
    	<ant:uptodate property="parser.generation.required"
              targetfile="${parser.src.generated.dir}/org/andromda/core/translation/parser/parser.dat" >
      		<ant:srcfiles dir="${parser.src.dir}" includes="${parser.grammer.file}" />
    	</ant:uptodate>
  	</goal>

    <!-- ===================================================================
         Generates the parser files using SableCC (@see www.sablecc.org)    
         =================================================================== -->
  	<goal name="build-parser" prereqs="check-parser-required">
  		<ant:mkdir dir="${parser.src.generated.dir}"/>
  		<j:choose>
  			<j:when test="${parser.generation.required}">
  				<ant:echo>Parser grammer has not changed since last generation.</ant:echo>
  			</j:when>
  			<j:otherwise>
		    	<ant:taskdef name="sablecc"
		             classname="org.sablecc.ant.taskdef.Sablecc"
		             classpathref="maven.dependency.classpath"/>
		    	<ant:sablecc outputdirectory="${parser.src.generated.dir}" src="${parser.src.dir}">
		      		<ant:include name="${parser.grammer.file}" />
		    	</ant:sablecc>
  			</j:otherwise>
  		</j:choose>
  	</goal>
  	
    <!-- ===================================================================
         Clean's the parser generated output
         =================================================================== -->
  	<goal name="clean-parser">
  		<ant:delete dir="${parser.src.generated.dir}"/>
  	</goal>
  		 
</project>
